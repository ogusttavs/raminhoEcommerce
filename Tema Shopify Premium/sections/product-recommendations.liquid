<section class="product-recommendations-section section-padding" style="background: var(--color-background-alt); padding: 6rem 0; overflow: hidden;">
  <div class="container">
    <div class="section-header" style="margin-bottom: 2rem;">
      <span class="product-eyebrow font-body" style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.6;">Continue sua colheita</span>
      <h2 class="font-heading h2">Recomendados para você</h2>
    </div>
  </div>

  <style>
    .product-recommendations-wrapper {
      position: relative;
      width: 100%;
    }
    .product-grid-netflix {
      display: flex;
      gap: 1.5rem;
      overflow-x: auto;
      padding: 0 1.5rem 2.5rem 0;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding-left: max(1.5rem, calc((100vw - 1440px) / 2 + 1.5rem));
    }
    .product-grid-netflix::-webkit-scrollbar {
      display: none;
    }
    .netflix-item {
      flex: 0 0 280px;
      scroll-snap-align: start;
      transition: transform 0.3s ease;
    }
    .rec-nav-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--color-primary-dark);
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
    }
    .product-recommendations-wrapper:hover .rec-nav-btn {
      opacity: 1;
      pointer-events: auto;
    }
    .rec-nav-btn:hover {
      background: var(--color-primary);
      color: #fff;
      transform: translateY(-50%) scale(1.1);
    }
    @media (max-width: 768px) {
      .netflix-item {
        flex: 0 0 240px;
        scroll-snap-align: center;
      }
      .product-grid-netflix {
        padding-left: 1rem;
        gap: 1rem;
      }
    }
  </style>

  <div class="product-recommendations-wrapper">
    <div class="container" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); height: 100%; pointer-events: none; z-index: 10;">
      <button class="rec-nav-btn btn-prev" aria-label="Anterior" style="left: -22px;">
        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
      </button>
      <button class="rec-nav-btn btn-next" aria-label="Próximo" style="right: -22px;">
        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
      </button>
    </div>

    <div class="product-recommendations" data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit=6">
      {%- if recommendations.performed and recommendations.products_count > 0 -%}
        <div class="product-grid-netflix">
          {%- for recommended_product in recommendations.products -%}
            <div class="netflix-item">
              {% render 'product-card-premium', product: recommended_product, section: section %}
            </div>
          {%- endfor -%}
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

<script>
  const setupNav = (container) => {
    const btnPrev = container.querySelector('.btn-prev');
    const btnNext = container.querySelector('.btn-next');
    const track = container.querySelector('.product-grid-netflix');
    if (!track || !btnPrev || !btnNext) return;

    btnNext.addEventListener('click', () => {
      const slide = track.querySelector('.netflix-item');
      track.scrollBy({ left: slide.offsetWidth + 24, behavior: 'smooth' });
    });
    btnPrev.addEventListener('click', () => {
      const slide = track.querySelector('.netflix-item');
      track.scrollBy({ left: -(slide.offsetWidth + 24), behavior: 'smooth' });
    });
  };

  const handleIntersection = (entries, observer) => {
    if (!entries[0].isIntersecting) return;
    observer.unobserve(entries[0].target);

    const url = entries[0].target.dataset.url;
    fetch(url)
      .then(response => response.text())
      .then(text => {
        const html = new DOMParser().parseFromString(text, 'text/html');
        const recommendations = html.querySelector('.product-recommendations');
        if (recommendations && recommendations.innerHTML.trim().length > 0) {
          entries[0].target.innerHTML = recommendations.innerHTML;
          setupNav(entries[0].target.closest('.product-recommendations-section'));
        }
      });
  };

  const observer = new IntersectionObserver(handleIntersection, {rootMargin: '0px 0px 400px 0px'});
  const recSection = document.querySelector('.product-recommendations');
  if(recSection) observer.observe(recSection);
</script>

{% schema %}
{
  "name": "Recomendações de Produto",
  "settings": [],
  "presets": [
    {
      "name": "Recomendações de Produto"
    }
  ]
}
{% endschema %}
