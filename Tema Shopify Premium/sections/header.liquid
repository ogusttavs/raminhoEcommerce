{% comment %}
  Header Premium Sticky
  - Fundo transparente ou sólido dependendo do scroll (animado no CSS)
  - Logo centralizado
  - Ícones minimalistas (Busca, User, Cart)
{% endcomment %}

{{ 'header.css' | asset_url | stylesheet_tag }}

<header class="header-premium {% if template.name == 'product' %}is-on-product{% endif %}" id="SiteHeader">
  <div class="container header-inner flex justify-between items-center">
    
    <!-- Esquerda: Menu Hamburger (Mobile) & Busca -->
    <div class="header-left flex items-center">
      <button class="header-icon-btn hidden-desktop" aria-label="Menu" onclick="openMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
      <button class="header-icon-btn" aria-label="Buscar" onclick="openSearch()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
    </div>

    <!-- Centro: Logo & Desktop Nav -->
    <div class="header-center">
      <a href="{{ routes.root_url }}" class="header-logo">
        {% if section.settings.logo != blank %}
          <img src="{{ section.settings.logo | image_url: width: 300 }}" 
               alt="{{ shop.name }}" 
               width="{{ section.settings.logo_width | divided_by: 1.2 }}" 
               height="auto" 
               loading="eager"
               class="header-logo-img">
        {% else %}
          <img src="{{ 'logo_raminho_oficial.svg' | asset_url }}" 
               alt="{{ shop.name }}" 
               width="{{ section.settings.logo_width | default: 110 | divided_by: 1.2 }}" 
               height="auto" 
               loading="eager"
               class="header-logo-img header--white"
               style="border-radius: 4px;">
        {% endif %}
      </a>
      <nav class="header-nav hidden-mobile">
        <ul>
          <li><a href="/collections/frutas-epoca">Frutas de Época</a></li>
          <li><a href="/collections/cestas-premium">Cestas Raminho</a></li>
          <li><a href="/collections/colheita-dia">Colheita do Dia</a></li>
          <li><a href="/pages/assinaturas">Assinaturas</a></li>
          <li><a href="/pages/sobre-nos">Nossa Safra</a></li>
        </ul>
      </nav>
    </div>

    <!-- Direita: Conta & Carrinho -->
    <div class="header-right flex items-center">
      <a href="{{ routes.account_url }}" class="header-icon-btn hidden-mobile" aria-label="Conta">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </a>
      <a href="{{ routes.cart_url }}" class="header-icon-btn cart-btn" aria-label="Carrinho">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M6 19L3 6h18l-3 13H6zM9 6V4a3 3 0 0 1 6 0v2M4 10h16"/>
        </svg>
        {% if cart.item_count > 0 %}
          <span class="cart-count">{{ cart.item_count }}</span>
        {% endif %}
      </a>
    </div>
  </div>

  <!-- Menu Drawer (Mobile) -->
  <div id="MenuDrawer" class="menu-drawer">
    <div class="menu-drawer-inner">
       <div class="menu-drawer-header flex justify-between items-center">
          <h2 class="font-heading" style="font-size: 1.5rem; color: var(--color-primary-dark);">Menu</h2>
          <button class="header-icon-btn" onclick="closeMenu()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6 6 18M6 6l12 12"/></svg>
          </button>
       </div>
       <nav class="menu-drawer-nav">
          <ul class="menu-drawer-links no-bullets">
             <li><a href="/collections/frutas-epoca" class="font-heading">Frutas de Época</a></li>
             <li><a href="/collections/cestas-premium" class="font-heading">Cestas Raminho</a></li>
             <li><a href="/collections/colheita-dia" class="font-heading">Colheita do Dia</a></li>
             <li><a href="/pages/assinaturas" class="font-heading">Assinaturas</a></li>
             <li style="margin-top: 2rem;"><a href="/pages/sobre-nos" class="font-body" style="font-size: 1rem; opacity: 0.7;">Nossa Safra</a></li>
             <li><a href="/pages/contato" class="font-body" style="font-size: 1rem; opacity: 0.7;">Suporte</a></li>
          </ul>
       </nav>
       <div class="menu-drawer-footer">
          <a href="{{ routes.account_url }}" class="btn-primary-apple" style="width: 100%; display: flex; justify-content: center; font-size: 0.9rem;">
             Minha Conta
          </a>
       </div>
    </div>
    <div class="menu-drawer-overlay" onclick="closeMenu()"></div>
  </div>

  <!-- Search Drawer -->
  <div id="SearchDrawer" class="search-drawer">
    <div class="search-drawer-inner">
      <div class="container">
        <div class="search-drawer-header flex justify-between items-center">
          <h2 class="font-heading">O que você procura?</h2>
          <button class="header-icon-btn" onclick="closeSearch()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6 6 18M6 6l12 12"/></svg>
          </button>
        </div>
        
        <form action="{{ routes.search_url }}" method="get" role="search" class="search-drawer-form">
          <div class="search-input-wrapper">
            <input type="text" 
                   name="q" 
                   placeholder="Pesquise por frutas, cestas ou especiarias..." 
                   class="search-drawer-input"
                   id="SearchDrawerInput"
                   autocomplete="off"
                   oninput="handleSearchInput(this.value)">
            <button type="submit" class="search-submit-btn">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            </button>
          </div>
          <div id="PredictiveSearchResults" class="predictive-search-results-container"></div>
        </form>
      </div>
    </div>
    <div class="search-drawer-overlay" onclick="closeSearch()"></div>
  </div>
</header>

<script>
  // Header Logic
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.getElementById('SiteHeader');
    let lastScrollY = window.scrollY;

    window.addEventListener('scroll', () => {
      const scrollPos = window.scrollY;
      
      // 1. Color Change (Soon after start)
      if (scrollPos > 100) {
        header.classList.add('is-scrolled');
      } else {
        header.classList.remove('is-scrolled');
      }

      // 2. Floating Pill Logic (Once out of Hero)
      // We use a threshold of 300px to ensure we are clearly out of the first section
      if (scrollPos > 300) {
        header.classList.add('is-sticky');
      } else {
        header.classList.remove('is-sticky');
      }
      
      // Removed the 'is-hidden' logic that was hiding it on scroll down,
      // as per user request to have constant access until back to the start.
      
      lastScrollY = scrollPos;
    }, { passive: true });
  });

  // Menu Toggle
  function openMenu() {
    const drawer = document.getElementById('MenuDrawer');
    drawer.classList.add('is-active');
    document.body.style.overflow = 'hidden';
  }

  function closeMenu() {
    const drawer = document.getElementById('MenuDrawer');
    drawer.classList.remove('is-active');
    document.body.style.overflow = '';
  }

  // Search Toggle
  function openSearch() {
    const drawer = document.getElementById('SearchDrawer');
    drawer.classList.add('is-active');
    document.body.style.overflow = 'hidden';
    setTimeout(() => document.getElementById('SearchDrawerInput').focus(), 300);
  }

  function closeSearch() {
    const drawer = document.getElementById('SearchDrawer');
    drawer.classList.remove('is-active');
    document.body.style.overflow = '';
  }

  // Predictive Search Logic
  let searchTimeout;
  function handleSearchInput(query) {
    if (query.length < 3) {
      document.getElementById('PredictiveSearchResults').innerHTML = '';
      return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      fetch(`/search/suggest?q=${query}&resources[type]=product,collection&section_id=predictive-search`)
        .then(response => response.text())
        .then(text => {
          const results = new DOMParser().parseFromString(text, 'text/html').querySelector('#predictive-search-results');
          if (results) {
            document.getElementById('PredictiveSearchResults').innerHTML = results.innerHTML;
          }
        });
    }, 300);
  }
</script>

{% schema %}
{
  "name": "Header Premium",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Principal (Recomendado: Versão Dark ou Heritage)"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 250,
      "step": 10,
      "default": 100,
      "unit": "px",
      "label": "Largura da Logo"
    }
  ]
}
{% endschema %}
