{{ 'product-page.css' | asset_url | stylesheet_tag }}

<section class="product-section">
  {%- assign product_form_id = 'product-form-' | append: section.id -%}
  <div class="container">
    <div class="product-grid">
      
      <!-- Lado Esquerdo: Galeria Apple Style (Stack de imagens grandes) -->
      <div class="product-gallery">
        {% for image in product.images %}
          <img src="{{ image | image_url: width: 1200 }}" 
               alt="{{ image.alt | escape | default: product.title }}"
               loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
               width="1200" height="auto">
        {% else %}
          <div style="background:var(--color-background-alt); height: 600px; display:flex; align-items:center; justify-content:center; border-radius: 16px;">
            <p>Produto sem imagem</p>
          </div>
        {% endfor %}
      </div>

      <!-- Lado Direito: Informações Fixas (Sticky) -->
      <div class="product-info-sticky">
        <div class="product-info-inner">
        {% assign cheapest_variant = product.variants | sort: 'price' | first %}
        
        <!-- Renderiza os blocos na ordem que o lojista definiu no painel da Shopify -->
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            
            {%- when '@app' -%}
              {% render block %}
            
            {%- when 'title' -%}
              <div class="product-header-group" {{ block.shopify_attributes }}>
                <span class="product-eyebrow font-body">Safra Especial Raminho</span>
                <h1 class="product-title font-heading">{{ product.title }}</h1>
              </div>
            
            {%- when 'price' -%}
              <div class="product-price-wrapper" id="price-{{ section.id }}" {{ block.shopify_attributes }}>
                <span class="product-price-label font-body">A partir de</span>
                <span class="product-price price-current">{{ cheapest_variant.price | money }}</span>
              </div>
            
            {%- when 'variant_picker' -%}
              <!-- Seletor Exclusivo estilo iOS -->
              {%- unless product.has_only_default_variant -%}
                <variant-selects data-section="{{ section.id }}" data-url="{{ product.url }}" {{ block.shopify_attributes }}>
                  {%- for option in product.options_with_values -%}
                    <div class="variant-selector-wrapper" {% if forloop.index0 > 0 %}style="display:none;"{% else %}style="margin-bottom: 2rem;"{% endif %}>
                      <label class="variant-label font-body">{{ option.name }}</label>
                      <div class="segmented-control">
                        {%- for value in option.values -%}
                          {% assign is_checked = false %}
                          {% if cheapest_variant.options[forloop.parentloop.index0] == value %}
                            {% assign is_checked = true %}
                          {% endif %}
                          
                          <input type="radio" 
                                 id="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                                 class="variant-radio"
                                 name="options[{{ option.name | escape }}]"
                                 value="{{ value | escape }}"
                                 {% if is_checked %}checked{% endif %}
                          >
                          <label class="segmented-btn" style="user-select: none;" for="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}">
                            {{ value }}
                          </label>
                        {%- endfor -%}
                      </div>
                    </div>
                  {%- endfor -%}
                  
                  <!-- Tag select oculta para a Shopify processar o form nativo via JS -->
                  <script type="application/json">
                    {{ product.variants | json }}
                  </script>
                </variant-selects>
              <!-- Variante Picker Fim -->
              {%- endunless -%}
            
            {%- when 'buy_buttons' -%}
              <div {{ block.shopify_attributes }} style="margin-bottom: 2.5rem;">
                <smart-add-to-cart data-section="{{ section.id }}">
                  {%- form 'product', product, id: product_form_id, class: 'product-form' -%}
                    <input type="hidden" name="id" class="variant-id-input" value="{{ cheapest_variant.id }}">
                    
                    <div class="buy-section-labels flex justify-between items-end" style="margin-bottom: 0.8rem;">
                       <span class="font-body" style="font-size: 0.85rem; opacity: 0.6; text-transform: uppercase; font-weight: 600;">Quantidade</span>
                       <span class="font-body" style="font-size: 0.85rem; opacity: 0.6; text-transform: uppercase; font-weight: 600;">Subtotal</span>
                    </div>

                    <!-- Smart Quantity Stepper iOS Style -->
                    <div class="product-qty-stepper flex items-center justify-between">
                      <button type="button" class="stepper-btn stepper-minus text-dark" aria-label="Diminuir">
                        &minus;
                      </button>
                      
                      <input type="number" name="quantity" class="stepper-input hidden" value="1" min="1" style="display:none;">
                      
                      <div class="stepper-display">
                        <span class="stepper-text font-body text-dark">
                          1 un
                        </span>
                      </div>

                      <button type="button" class="stepper-btn stepper-plus text-dark" aria-label="Aumentar">
                        &plus;
                      </button>
                    </div>

                    <div class="product-form__buttons">
                      <button type="submit" 
                              name="add" 
                              class="product-add-to-cart font-body"
                              style="display: flex; justify-content: space-between; align-items: center; width: 100%; border:none; outline:none; background-color: var(--color-primary); color: #fff; border-radius: 50px; padding: 1.2rem 2rem; box-shadow: 0 8px 20px rgba(13, 124, 74, 0.2); cursor: pointer;"
                              {% if cheapest_variant.available == false %}disabled{% endif %}>
                        <span class="btn-text" style="font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">
                          {% if cheapest_variant.available %}
                            Adicionar ao Carrinho
                          {% else %}
                            Esgotado
                          {% endif %}
                        </span>
                        <span class="btn-price" data-base-price="{{ cheapest_variant.price }}" style="font-weight: 800; font-size: 1.2rem;">
                          {% if cheapest_variant.available %}
                            {{ cheapest_variant.price | money }}
                          {% endif %}
                        </span>
                      </button>
                    </div>
                  {%- endform -%}
                </smart-add-to-cart>
              </div>

            {%- when 'description' -%}
              {%- if product.description != blank -%}
                <div class="product-accordions-group" {{ block.shopify_attributes }}>
                  
                  <details class="product-accordion" open>
                    <summary class="accordion-header">
                      <span class="font-heading">Sobre esta Colheita</span>
                      <svg class="icon-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    </summary>
                    <div class="accordion-content font-body">
                      {{ product.description }}
                    </div>
                  </details>

                  <details class="product-accordion">
                    <summary class="accordion-header">
                      <span class="font-heading">Entrega & Frescor</span>
                      <svg class="icon-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    </summary>
                    <div class="accordion-content font-body">
                      <p>Sua encomenda é colhida no ponto perfeito de maturação. Entregamos em até 24h (D+1) em embalagens térmicas sustentáveis que garantem que a fruta chegue à sua mesa como se tivesse acabado de sair do pé.</p>
                    </div>
                  </details>

                </div>
              {%- endif -%}

            {%- when 'trust_badge' -%}
              <div class="trust-badge flex items-center" style="gap: 1rem; margin-top: 3rem; opacity: 0.8;" {{ block.shopify_attributes }}>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--color-primary);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <span class="font-body" style="font-size: 0.9rem;">Entrega D+1 Cuidadosa. Frescor Garantido Raminho.</span>
              </div>
              
          {%- endcase -%}
        {%- endfor -%}
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de Compra Sticky (Apple Style) -->
  <div id="sticky-add-to-cart" class="sticky-buy-bar">
    <div class="container flex justify-between items-center">
      <div class="sticky-product-info flex items-center gap-4">
        <img src="{{ product.featured_image | image_url: width: 100 }}" alt="{{ product.title }}" width="50" height="50" class="sticky-thumb">
        <div class="sticky-text-group">
          <span class="sticky-title font-heading">{{ product.title }}</span>
          <span class="sticky-price font-body price-current">{{ cheapest_variant.price | money }}</span>
        </div>
      </div>
      
      <div class="sticky-actions">
        <button type="button" class="btn-primary-apple sticky-submit" onclick="document.querySelector('#{{ product_form_id }} [name=add]').click()">
          <span class="btn-text">Adicionar</span>
          <span class="btn-price-divider"></span>
          <span class="btn-price sticky-current-price">{{ cheapest_variant.price | money }}</span>
        </button>
      </div>
    </div>
  </div>
</section>

<script>
  window.addEventListener('scroll', function() {
    const triggerElement = document.querySelector('.product-accordions-group') || document.querySelector('.product-add-to-cart');
    const stickyBar = document.getElementById('sticky-add-to-cart');
    if(!triggerElement || !stickyBar) return;
    
    const triggerRect = triggerElement.getBoundingClientRect();
    // Start appearing when the 'Sobre esta colheita' group is near the top or when the main button is gone
    if (triggerRect.top < 150) {
      stickyBar.classList.add('is-active');
    } else {
      stickyBar.classList.remove('is-active');
    }
  });

  // Sincronizar preços e variantes entre o form principal e o sticky
  function updateStickyPrice() {
     const mainPriceEl = document.querySelector('.product-price.price-current');
     const qtyInput = document.querySelector('input[name="quantity"]');
     if(!mainPriceEl || !qtyInput) return;

     const priceText = mainPriceEl.textContent;
     const unitPrice = parseFloat(priceText.replace('R$', '').replace('.', '').replace(',', '.').trim());
     const quantity = parseInt(qtyInput.value) || 1;
     
     if (!isNaN(unitPrice)) {
        const total = unitPrice * quantity;
        const formattedTotal = 'R$ ' + total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.querySelectorAll('.btn-price').forEach(el => el.textContent = formattedTotal);
        // A sticky-price menor continua mostrando o preço unitário para referência? 
        // Não, o usuário quer que tudo atualize.
        document.querySelectorAll('.sticky-price').forEach(el => el.textContent = formattedTotal);
     } else {
        document.querySelectorAll('.btn-price').forEach(el => el.textContent = priceText);
        document.querySelectorAll('.sticky-price').forEach(el => el.textContent = priceText);
     }
  }

  document.addEventListener('change', function(e) {
     if(e.target.classList.contains('variant-radio') || e.target.name === 'quantity') {
        setTimeout(updateStickyPrice, 50);
     }
  });

  // Observer para mudanças de texto no preço (caso o tema atualize via JS)
  const priceObserver = new MutationObserver(updateStickyPrice);
  const targetPrice = document.querySelector('.product-price.price-current');
  if(targetPrice) {
    priceObserver.observe(targetPrice, { childList: true, characterData: true, subtree: true });
  }

  // Listener para botões de quantidade (casos comuns de + / -)
  document.addEventListener('click', function(e) {
    if(e.target.closest('.qty-btn') || e.target.closest('.quantity-button')) {
      setTimeout(updateStickyPrice, 100);
    }
  });
</script>

<!-- Unified Component loaded below -->
<script src="{{ 'smart-add-to-cart.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Página de Produto",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "title",
      "name": "Título",
      "limit": 1
    },
    {
      "type": "price",
      "name": "Preço",
      "limit": 1
    },
    {
      "type": "variant_picker",
      "name": "Seletor de Variantes",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Botão de Compra",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Botão de Compra",
      "limit": 1
    },
    {
      "type": "description",
      "name": "Descrição do Produto",
      "limit": 1
    },
    {
      "type": "trust_badge",
      "name": "Selo de Garantia",
      "limit": 1
    }
  ],
  "settings": []
}
{% endschema %}
