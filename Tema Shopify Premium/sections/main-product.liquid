{{ 'product-page.css' | asset_url | stylesheet_tag }}

<section class="product-section">
  <div class="container">
    <div class="product-grid">
      
      <!-- Lado Esquerdo: Galeria Apple Style (Stack de imagens grandes) -->
      <div class="product-gallery">
        {% for image in product.images %}
          <img src="{{ image | image_url: width: 1200 }}" 
               alt="{{ image.alt | escape | default: product.title }}"
               loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
               width="1200" height="auto">
        {% else %}
          <div style="background:var(--color-background-alt); height: 600px; display:flex; align-items:center; justify-content:center; border-radius: 16px;">
            <p>Produto sem imagem</p>
          </div>
        {% endfor %}
      </div>

      <!-- Lado Direito: Informações Fixas (Sticky) -->
      <div class="product-form-container">
        {% assign cheapest_variant = product.variants | sort: 'price' | first %}
        
        <!-- Renderiza os blocos na ordem que o lojista definiu no painel da Shopify -->
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            
            {%- when '@app' -%}
              {% render block %}
            
            {%- when 'title' -%}
              <h1 class="product-title font-heading" {{ block.shopify_attributes }}>{{ product.title }}</h1>
            
            {%- when 'price' -%}
              <div class="product-price-wrapper" id="price-{{ section.id }}" {{ block.shopify_attributes }}>
                <span class="product-price">{{ cheapest_variant.price | money }}</span>
              </div>
            
            {%- when 'variant_picker' -%}
              <!-- Seletor Exclusivo estilo iOS -->
              {%- unless product.has_only_default_variant -%}
                <variant-selects data-section="{{ section.id }}" data-url="{{ product.url }}" {{ block.shopify_attributes }}>
                  {%- for option in product.options_with_values -%}
                    <div class="variant-selector-wrapper" {% if forloop.index0 > 0 %}style="display:none;"{% else %}style="margin-bottom: 1.5rem;"{% endif %}>
                      <label class="variant-label font-body">{{ option.name }}</label>
                      <div class="segmented-control" style="background: rgba(0,0,0,0.04); padding: 4px; border-radius: 12px;">
                        {%- for value in option.values -%}
                          {% assign is_checked = false %}
                          {% if cheapest_variant.options[forloop.parentloop.index0] == value %}
                            {% assign is_checked = true %}
                          {% endif %}
                          
                          <input type="radio" 
                                 id="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                                 class="variant-radio"
                                 name="options[{{ option.name | escape }}]"
                                 value="{{ value | escape }}"
                                 form="product-form-{{ section.id }}"
                                 {% if is_checked %}checked{% endif %}
                          >
                          <label class="segmented-btn" style="user-select: none;" for="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}">
                            {{ value }}
                          </label>
                        {%- endfor -%}
                      </div>
                    </div>
                  {%- endfor -%}
                  
                  <!-- Tag select oculta para a Shopify processar o form nativo via JS -->
                  <script type="application/json">
                    {{ product.variants | json }}
                  </script>
                </variant-selects>
              {%- endunless -%}
            
            {%- when 'buy_buttons' -%}
              <div {{ block.shopify_attributes }} style="margin-bottom: 2rem;">
                <smart-add-to-cart data-section="{{ section.id }}">
                  {%- form 'product', product, id: 'product-form-' | append: section.id, class: 'product-form' -%}
                    <input type="hidden" name="id" class="variant-id-input" value="{{ cheapest_variant.id }}">
                    
                    <!-- Smart Quantity Stepper iOS Style -->
                    <div class="product-qty-stepper flex items-center justify-between" style="background: #fff; padding: 0.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                      <button type="button" class="stepper-btn stepper-minus text-dark" style="width: 50px; height: 50px; border:none; background:transparent; font-size:1.8rem; cursor:pointer; outline:none;" aria-label="Diminuir">
                        &minus;
                      </button>
                      
                      <input type="number" name="quantity" class="stepper-input hidden" value="1" min="1" style="display:none;">
                      
                      <div class="stepper-display text-center" style="flex:1;">
                        <span class="stepper-text font-body text-dark" style="font-weight: 600; font-size: 1.2rem;">
                          <!-- JS Init -->
                          1 un
                        </span>
                      </div>

                      <button type="button" class="stepper-btn stepper-plus text-dark" style="width: 50px; height: 50px; border:none; background:transparent; font-size:1.8rem; cursor:pointer; outline:none;" aria-label="Aumentar">
                        &plus;
                      </button>
                    </div>

                    <div class="product-form__buttons">
                      <button type="submit" 
                              name="add" 
                              class="product-add-to-cart font-body"
                              style="display: flex; justify-content: space-between; align-items: center; width: 100%; border:none; outline:none; box-shadow: 0 8px 20px rgba(13, 124, 74, 0.2);"
                              {% if cheapest_variant.available == false %}disabled{% endif %}>
                        <span class="btn-text" style="font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">
                          {% if cheapest_variant.available %}
                            Adicionar ao Carrinho
                          {% else %}
                            Esgotado
                          {% endif %}
                        </span>
                        <span class="btn-price" data-base-price="{{ cheapest_variant.price }}" style="font-weight: 800; font-size: 1.2rem;">
                          {% if cheapest_variant.available %}
                            {{ cheapest_variant.price | money }}
                          {% endif %}
                        </span>
                      </button>
                    </div>
                  {%- endform -%}
                </smart-add-to-cart>
              </div>

            {%- when 'description' -%}
              {%- if product.description != blank -%}
                <div class="product-description" {{ block.shopify_attributes }}>
                  {{ product.description }}
                </div>
              {%- endif -%}

            {%- when 'trust_badge' -%}
              <div class="trust-badge flex items-center" style="gap: 1rem; margin-top: 2rem; opacity: 0.8;" {{ block.shopify_attributes }}>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--color-primary);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <span class="font-body" style="font-size: 0.9rem;">Entrega D+1 Cuidadosa. Frescor Garantido Raminho.</span>
              </div>
              
          {%- endcase -%}
        {%- endfor -%}

      </div>
    </div>
  </div>
</section>

<!-- Unified Component loaded below -->
<script src="{{ 'smart-add-to-cart.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Página de Produto",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "title",
      "name": "Título",
      "limit": 1
    },
    {
      "type": "price",
      "name": "Preço",
      "limit": 1
    },
    {
      "type": "variant_picker",
      "name": "Seletor de Variantes",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Botão de Compra",
      "limit": 1
    },
    {
      "type": "description",
      "name": "Descrição do Produto",
      "limit": 1
    },
    {
      "type": "trust_badge",
      "name": "Selo de Garantia",
      "limit": 1
    }
  ],
  "settings": []
}
{% endschema %}
